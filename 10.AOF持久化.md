## AOF持久化  
AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。  
## AOF持久化与RDB持久化  
**区别**：RDB持久化保存数据库状态的方法是将键值对保存到RDB文件中，而AOF持久化保存数据库状态的方法是**将服务器执行的命令保存到AOF文件中**。  
被写入AOF文件的所有命令都是以Redis命令请求协议格式保存的，因为Redis的命令请求协议是纯文本格式，所以我们可以直接打开一个AOF文件。  
## AOF持久化的实现  
AOF持久化功能的实现可以分为命令追加，文件写入，文件同步三个步骤。    
## 命令追加  
当AOF持久化功能处于打开状态时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾。  
```
struct  redisServer{
        //...
        //AOF缓冲区
        sds aof_buf;
        //...
};
```
举个例子，如果客户端向服务器发送以下命令：
```
redis> SET KEY VALUE
OK
```
那么服务器在执行完这个SET命令之后，会将以下协议内容追加到aof_buf缓冲区末尾：
```
*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n。
```
## AOF文件的写入与同步  
Redis的服务进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。因为服务器在处理文件事件时。  
因为服务器在 处理文件事件时，可能会执行写命令，使得一些内容被追加到aof_buf缓冲区里面，所以在服务器每次结束一个事件循环前，它都会调用flushAppendOnlyFile函数，考虑是否需要将**aof_buf缓冲区中的内容写入和保存到AOF文件里面**。  
flushAppendOnlyFile函数的行为由服务器配置的appendfsync选项的值来决定，各个不同值产生的行为不同。  
appendfsync选项的值：  
（1）always：将aof_buf缓冲区中的所有内容写入并同步到aof文件中。  
（2）everysec：将aof_buf缓冲区中的所有内容写入到aof文件中，如果上次同步AOF文件的时间距离现在超过1秒，那么再次对AOF文件进行同步，并且这个同步操作是由一个线程专门负责执行的。  
（3）将aof_buf缓冲区中的所有内容写入到AOF文件，但并不对AOF文件进行同步，何时同步由操作系统决定。  
## AOF文件的载入与数据还原  
创建一个客户端，从AOF文件分析并读取写命令即可。   
## AOF重写  
比如说有如下情况
```
redis> SET msg "a"
redis> SET msg "c"
redis> SET msg "d"
redis> SET msg "e"
```
保存这样的情况要4条指令，其实则不然，只需要1条指令就行了。所以针对这样的情况。便有了重写功能的实现。  
## AOF文件重写的实现  
