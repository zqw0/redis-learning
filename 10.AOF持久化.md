## AOF持久化  
AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态的。  
## AOF持久化与RDB持久化  
**区别**：RDB持久化保存数据库状态的方法是将键值对保存到RDB文件中，而AOF持久化保存数据库状态的方法是**将服务器执行的命令保存到AOF文件中**。  
被写入AOF文件的所有命令都是以Redis命令请求协议格式保存的，因为Redis的命令请求协议是纯文本格式，所以我们可以直接打开一个AOF文件。  
## AOF持久化的实现  
AOF持久化功能的实现可以分为命令追加，文件写入，文件同步三个步骤。    
## 命令追加  
当AOF持久化功能处于打开状态时，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓冲区的末尾。  
```
struct  redisServer{
        //...
        //AOF缓冲区
        sds aof_buf;
        //...
};
```
举个例子，如果客户端向服务器发送以下命令：
```
redis> SET KEY VALUE
OK
```
那么服务器在执行完这个SET命令之后，会将以下协议内容追加到aof_buf缓冲区末尾：
```
*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n。
```
## AOF文件的写入与同步  
Redis的服务进程就是一个事件循环，这个循环中的文件事件负责接收客户端的命令请求，以及向客户端发送命令回复。因为服务器在处理文件事件时。  
因为服务器在 处理文件事件时，可能会执行写命令，使得一些内容被追加到aof_buf缓冲区里面，所以在服务器每次结束一个事件循环前，它都会调用flushAppendOnlyFile函数，考虑是否需要将**aof_buf缓冲区中的内容写入和保存到AOF文件里面**。  
flushAppendOnlyFile函数的行为由服务器配置的appendfsync选项的值来决定，各个不同值产生的行为不同。  
appendfsync选项的值：  
（1）always：将aof_buf缓冲区中的所有内容写入并同步到aof文件中。  
（2）everysec：将aof_buf缓冲区中的所有内容写入到aof文件中，如果上次同步AOF文件的时间距离现在超过1秒，那么再次对AOF文件进行同步，并且这个同步操作是由一个线程专门负责执行的。  
（3）将aof_buf缓冲区中的所有内容写入到AOF文件，但并不对AOF文件进行同步，何时同步由操作系统决定。  
## AOF文件的载入与数据还原  
创建一个客户端，从AOF文件分析并读取写命令即可。   
## AOF重写  
比如说有如下情况
```
redis> SET msg "a"
redis> SET msg "c"
redis> SET msg "d"
redis> SET msg "e"
```
保存这样的情况要4条指令，其实则不然，只需要1条指令就行了。所以针对这样的情况。便有了重写功能的实现。  
## AOF文件重写的实现   
考虑上面的情况，我们没有必要记录下每一条数据，只需要最后一条就可以。但是怎么记录最后一条呢，这里我们**在这个时间点上，直接读取数据库的状态即可**。数据库里面msg键存储的就是一个键值e，那么直接存入命令SET msg  "e"。即可。  
## AOF后台重写  
我们已经知道如何进行重写了，但是因为这个操作会进行大量的写入操作，所以**调用这个操作将被长时间的阻塞**。但是redis服务器使用单个线程来处理命令请求。如果此进程调用此函数的话，那么在重写AOF文件期间，服务器将无法处理客户端发来的命令请求。  
所以**Redis将AOF重写程序放到子进程里执行**。这里有**两点好处**：  
（1）子进程进行AOF重写期间，服务器进程可以继续处理命令请求。  
（2）子进程带有服务器进程的副本数据，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据的安全性。
**但是这样做，有一点数据同步的问题。当子进程进行写入AOF文件，而父进程处理新的写入命令后，就会导致写入的AOF和父进程此时的数据库状态不一致**。    
**解决办法**：设置一个AOF重写缓冲区。  
（1）：当**创建子进程时**，服务器执行的**所有写命令**都会被记录到AOF重写缓冲区里面。  
（2）：当**子进程完成AOF文件重写工作后**，向父进程发完成信号。  
（3）：父进程收到完成信号后，**将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前数据库状态一致**。  
（4）：父进程，对新的AOF文件进行改名，原子地覆盖现有的AOF文件，完成新旧两个AOF文件的替换。  
**总结**：所以AOF重写任务，只有在父进程收到完成信号后，所做的一些工作。会导致父进程暂时的不接收消息。  
举例：  
```
时间                                                                      服务器进程（父进程）                                                                                                              子进程
T1                                                                              执行命令SET K1 V1                                                                                                                   
T2                                                                              执行命令SET K1 V2   
T3                                                                              执行命令SET K1 V3
T4                                                                              创建子进程，执行AOF文件重写                                                                                         开始AOF文件重写
T5                                                                              执行命令SET K2 10086                                                                                                         执行重写操作
T6                                                                              执行命令SET K3 12345                                                                                                        执行重写操作
T7                                                                              执行命令SET K4 22222                                                                                                        完成AOF文件重写，向父进程发送信号
T8                                                                              接收到子进程发来的信号，将SET K2，K3，K4追加到新AOF文件末尾              
T9                                                                              用新AOF文件覆盖旧AOF文件
```
以上就是**AOF后台重写，也是BGREWRITEAOF命令实现原理**。





