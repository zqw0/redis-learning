## Sentinel含义  
Sentinel（哨兵，哨岗）是redis高可用性解决方案：**由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代表已下线的主服务器继续处理命令请求。**   
**大致流程**：当主服务器下线时长超过用户设定的下线时长上限时，Sentinel系统就会对主服务器执行故障转移操作：  
（1）首先，Sentinel系统会挑选主服务器下的一个从服务器，并将这个被选中的从服务器升级为新的主服务器。  
（2）之后，Sentinel系统会向主服务器下的所有从服务器发送新的复制指令，让他们成为新的主服务器的从服务器，当所有从服务器都开始复制新的主服务器时，故障转移操作执行完毕。  
（3）另外，Sentinel系统还会继续监视已下线的主服务器，并在它重新上线时，将它设置为新的主服务器 的从服务器。  
## 启动并初始化Sentinel  
启动一个Sentinel可以使用命令：  
```
$ redis-sentinel /path/to/your/sentinel.conf
或者
$ redis-server /path/to/your/sentinel.conf --sentinel
```
当启动一个Sentinel时，它需要执行以下步骤：  
（1）初始化服务器。  
（2）将普通redis服务器使用的代码替换成Sentinel专用代码。  
（3）初始化Sentinel状态。  
（4）根据给定的配置文件，初始化Sentinel的监视主服务器列表。  
（5）创建连向主服务器的网络连接。  
## 初始化服务器  
首先，因为Sentinel本质上只是一个运行在特殊模式下的redis服务器，所以启动Sentinel的第一步，就是初始化一个普通的redis服务器。但是和普通的redis服务器的初始化过程并不完全相同。例如：普通服务器在初始化会通过载入rdb文件或者aof文件来还原数据库状态，但Sentinel并不使用数据库，所以不需要这步。  
## 使用Sentinel专用代码   
比如普通redis服务器使用REDIS_SERVERPORT常量的值作为服务器端口：
```
#define REDIS_SERVERPORT 6379
```
而Sentinel则使用REDIS_SENTINEL_PORT常量值作为服务器端口：
```
#define REDIS_SENTINEL_PORT 26379
```
除此之外，普通redis服务器使用redisCommanTable作为服务器的命令表。而Sentinel使用sentinelcmds作为命令。  
## 初始化Sentinel状态  
在应用了Sentinel的专用代码之后，服务器初始化一个sentinelStat结构，这个结构保存了服务器中所有和Sentinel功能有关的状态：
```
struct sentinelState{
        //当前纪元，用于实现故障转移
        uint64_t current_epoch;
         
        //保存了所有被这个sentinel监视的 主服务器
        //字典的键是主服务器的名字
        //字典的值则是一个sentinelRedisInstance结构的指针
        dict *masters;
        
        //是否进入了TILT模式？
        int tilt;
        
        //目前正在执行的脚本的数量
        int running_scripts;
        
        //进入TILT模式的时间
        mstime_t tilt_start_time;
        
        //最后一次执行时间处理器的时间
        mstime_t previous_time;
        
        //一个FIFO队列， 包含了所有需要执行的用户脚本。
        list *scripts_queue;
};
```
## 初始化Sentinel状态的masters属性  
master属性记录了所有被Sentinel监视的主服务器的相关信息。字典的键是主服务器的名字，字典的值则是一个sentinelRedisInstance结构的指针。
