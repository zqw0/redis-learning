## 介绍
本章将对redis服务器的数据库实现进行详细介绍，说明服务器保存数据库的方法，客户端切换数据库的方法，数据库保存键值对的方法，以及针对数据库的添加、删除、查看、更新操作的实现方法等。  
## 服务器中的数据库  
redis服务器的结构体如下。redis服务器将所有数据库都保存在这里。  
```
struct redisServer{
          //...
          //一个数组，保存着服务器中的所有数据库
          redisDB *db;
          //初始化服务器时，程序会根据服务器状态的dbnum属性来决定应该创建多少个数据库。（一般默认情况下为16个）
          int dbnum;
};
```
## 切换数据库  
**默认情况下，redis客户端的目标数据库为0号数据库，但客户端可以通过执行SELECT命令来切换目标数据库**。如下示例演示了客户端在0号数据库设置并读取键msg，之后切换2号数据库并执行类似操作的过程：  
```
redis>  SET msg "hello  world"
OK

redis>  GET msg
"hello  world"

redis>  SELECT  2
OK

redis[2]> GET msg
(nil)
```
在服务器内部，客户端状态redisClient结构的db属性记录了客户端当前的目标数据库，这个属性是一个指向redisDB结构的指针：
```
typedef struct redisClient{
        //..
        //记录客户端当前正在使用的数据库。
        redisDB *db;
        //...
}redisClient;
```
## 数据库键空间   
redis是一个键值对数据库服务器，服务器中的每个数据库都由一个redisDb结构表示，其中redisDb结构的dict字典保存了数据库中的所有键值对。我们将这个字典称为键空间。：  
```
typedef struct redisDb{
          //...
          //数据库键空间，保存着数据库中的所有键值对
          dict      *dict;
          //...
}redisDb;
```
（1）键空间的键也就是数据库的键，每个键都是一个字符串对象。  
（2）键空间的值也就是数据库的值，每个值可以是字符串对象，列表对象，哈希表对象、集合对象和有序集合对象中的任意一种redis对象。  
## 对键的添加删除修改  
因为存键值对是存在字典中，那么他的操作，也就是对字典进行操作。就不再介绍了。  
**FLUSHDB命令，删除键空间中的所有键值对**。   
## 读写键空间时的维护操作  
当使用redis命令对数据库进行读写时，服务器不仅会对键空间执行指定的读写操作，还会执行一些额外的维护操作，其中包括：    
（1）在读取一个键之后（读写操作都要对键进行读取），服务器会根据键是否存在来更新服务器的键空间命中（hit）次数或键空间不命中（miss）次数，这两个值可以在INFO stats命令的keyspace_hits属性和keyspace_misses属性中查看。  
（2）在读取一个键之后，服务器会更新键的LRU（最后一次使用）时间，这个值可以用于计算键的闲置时间，使用OBJECT idletime<key>命令可以查看键key的闲置时间    （3）如果服务器在读取一个键时发现该键已经过期，那么服务器会先删除这个过期键，然后才执行余下的其他操作。   
（4）          


