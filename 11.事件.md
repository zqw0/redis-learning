## 事件的分类与介绍  
**redis服务器是一个事件驱动程序，服务器需要处理以下两类事件**：  
（1）**文件事件**：redis**服务器通过套接字与客户端进行连接，而文件事件就是服务器对套接字操作的抽象**。服务器端与客户端的通信会产生相应的文件事件，而服务器则通过监听并处理这些事件来完成一系列网络通信操作。  
（2）**时间事件**：redis服务器的**一些操作（比如serverCorn函数）需要在给定的时间点执行**。而时间事件就是服务器对这类定时操作的抽象。  
## 文件事件  
**redis基于reactor模式开发了字节的网络事件处理器：这个处理器被称为文件事件处理器：**   
（1）文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器。  
（2）当被监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。  
## 文件事件处理器的构成  
分别为四部分，**套接字，I/O多路复用程序，文件事件分派器，事件处理器**。  
**再次解释文件事件**：文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答，写入，读取，关闭等操作时，就会产生一个文件事件。
**这四部分的大致工作流程**：I/O多路复用程序被套接字绑定。     
## i/o多路复用程序的实现  
底层实现是四个I/O复用的函数。select/epoll/evport/kqueue。至于选那个要看操作系统，redis会为你选择一个性能最高的底层函数来实现。  
## 事件类型  
（1）当套接字变得可读时（客户端对套接字执行write操作，或者执行close操作），或者有新的可应答（accept）套接字出现时（客户端对服务器的监听套接字执行connet操作），套接字产生AE_READABLE事件。   
（2）当套接字变得可写的时候，套接字产生AE_WRITABLE事件。  
## API  
p153,剩下总的来说就是网络编程的一些知识，不在叙述。  
## 时间事件  
redis的时间事件主要分为两类：   
（1）定时事件：让一段程序在指定的时间之后执行一次。比如说，让程序x在当前时间的30ms之后执行一次。  
（2）周期性事件：让一段程序每隔指定时间就执行一次。比如说，让程序Y每隔30ms就执行一次。  
**一个时间事件主要由以下三个属性组成**：  
（1）id：服务器为时间事件创建的全局唯一ID（标识号）。ID号按从小到大的顺序递增，新事件的ID号比旧事件的ID号要大。  
（2）when：毫秒精度的UNIX时间戳，记录了时间事件的到达时间。  
（3）timeProc：时间事件处理器，一个函数。当时间事件到达时，服务器就会调用相应的处理器来处理事件。   
**一个时间事件是定时事件还是周期性事件取决于时间事件取决于时间事件处理器的返回值**：  
（1）如果时间处理器返回AE_NOMORE，那么这个事件为定时事件，该事件在达到一次之后就会被删除，之后不再到达。  
（2）如果事件处理器返回一个非AE_NOMORE的整数值，那么这个事件为周期性事件。当一个时间事件到达之后，服务器会**根据时间处理器的返回值，对时间事件的when属性进行更新，让这个事件在一段时间之后再次到达**，并以这种方式一直更新并运行下去。**比如，如果一个时间处理器返回值为30，那么服务器应该对这个时间事件进行更新，让这个事件在30ms之后再次到达**。   
## 实现  
服务器将所有时间事件都放在一个无序链表中，每当时间事件执行器运行时，他就遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器。  
## API  
详情见p157  
## 时间事件应用实例：serverCron函数  
它的工作主要包括：  
（1）更新服务器的各类统计信息，比如时间，内存占用，数据库占用等。  
（2）清理数据库中的过期键值对。  
（3）关闭和清理连接失效的客户端。  
（4）尝试进行AOF或RDB持久化操作。  
（5）如果服务器是主服务器，那么对从服务器进行定期同步。  
（6）如果处于集群模式，对集群进行定期 同步和连接测试。  
此函数在服务器运行期间，以周期性事件的方式运行。redis默认规定每秒运行10次，平局每隔100ms运行一次。  
## 事件的调度与执行   
（1）时间事件与文件事件会轮番执行，且**都是原子的，不会出现抢占**。  
（2）时间事件的实际处理时间通常会比设定的到达时间晚一些。  














